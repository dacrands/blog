<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/app.a2f933b7ab5f58f2ecfb.css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style data-href="/component---src-templates-blog-template-js.592af373a9de1595b330.css">@import url(https://fonts.googleapis.com/css?family=Open+Sans:400,700);html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:Open Sans,sans-serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}.content{max-width:500px}.navbar{background:#3150bf}.navbar a{display:block;margin:.5rem 1rem;color:#fefeff}.navbar ul{list-style:none;display:flex}.navbar li,.navbar ul{margin:0}.footer{background:#141519;padding:1rem;margin-top:1rem;color:#3150bf}.footer small{display:block;font-size:70%}.footer ul{list-style:none;margin:0}.footer li{margin-bottom:.5rem}.footer .citation{color:#3150bf;transition:all .2s ease}.footer .citation:hover{color:#fefeff}.footer__link{display:inline-block;color:#5f7ef0;text-decoration:none;transition:all .2s ease}.footer__link:hover{color:#fefeff}.header{padding:2rem}.header h1{color:#3150bf}.header p{margin-bottom:.25rem}.grid--aside{display:grid;grid-template-columns:220px 1fr;overflow:hidden}.pages{padding:0 2rem;display:flex;display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));grid-gap:20px}.pages__link{text-decoration:none;border:1px solid #dadada;padding:.5rem;color:rgba(0,0,0,.8);transition:all .2s ease;background:#3150bf;color:#fefeff}.pages__link small{color:#6e717e;color:#9baef5}.pages__link h3{margin-bottom:.25rem;color:#fefeff}.pages__link:hover{background:#132463}.pages__link-title{margin-bottom:1rem}.aside{background:#3150bf}.aside__nav{position:fixed;max-width:220px;padding:1rem;overflow-y:scroll;-webkit-overflow-scrolling:touch;max-height:100vh;color:#fefeff}.aside__nav-title{margin-bottom:2rem;white-space:nowrap;border-bottom:1px solid #132463;padding-bottom:.5rem;display:block;color:#fefeff;text-decoration:none}.aside__nav-title h2{margin-bottom:.35rem}.aside__nav-title small{line-height:100%}.aside__nav-title:hover h2{text-decoration:underline}.aside__nav-link{font-size:14px;line-height:110%;display:block;margin-bottom:2rem;color:#fefeff;text-decoration:none;font-weight:700}.aside__nav-link p{margin-bottom:.1rem}.aside__nav-link small{font-weight:400;color:#9baef5}.aside__nav-link:hover{text-decoration:underline}.aside__nav-link:hover small{color:#fefeff}.blog{max-width:600px;margin:0 auto;padding:0 1rem;font-family:Times New Roman,Times,serif}.blog h1,.blog h2{color:#3150bf}.blog h3{font-weight:400}.blog__header{padding:2rem 0}.blog__header h3{color:#5f7ef0;font-weight:400}@media (max-width:850px){.grid--aside{display:block}.aside__nav{position:relative;display:flex;overflow-y:auto;overflow-x:scroll;-webkit-overflow-scrolling:touch;max-width:100%}.aside__nav-title{margin-bottom:0;margin-right:2rem;align-self:center;border-bottom:none;border-right:1px solid #132463;padding-right:1rem}.aside__nav-link{display:inline-block;padding:1rem;margin-right:1rem;margin-bottom:0;min-width:200px}}</style><meta name="generator" content="Gatsby 2.0.76"/><title data-react-helmet="true"></title><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#042291"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-63c5b76c2806537627a9.js"/><link as="script" rel="preload" href="/app-33a09fa39d4bb1a5da5e.js"/><link as="script" rel="preload" href="/webpack-runtime-e208b5e9dd72a0235a91.js"/><link as="fetch" rel="preload" href="/static/d/658/path---blog-11-21-18-f-4-e-c1d-bfhqyGa5u8i8TzrL93yoIKVnp8.json" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><main class="grid--aside"><aside class="aside"><nav class="aside__nav"><a class="aside__nav-title" href="/"><h2>Blog</h2><small>by David Crandall</small></a><a class="aside__nav-link" href="/blog/4-2-2019"><p>Rejected After My First Technical Interview! Part 1: The Phoner</p><small>April 02, 2019</small></a><a class="aside__nav-link" href="/blog/1-6-2019"><p>Connect your SPA with your Back-end</p><small>January 06, 2019</small></a><a aria-current="page" class="aside__nav-link" style="color:#a8b1ce" href="/blog/11-21-18"><p>How NOT to Create a Dropbox Clone</p><small>November 21, 2018</small></a><a class="aside__nav-link" href="/blog/10-7-2018"><p>Hide Your Keys, Folks (Part II)</p><small>October 07, 2018</small></a><a class="aside__nav-link" href="/blog/10-6-18"><p>Downloading SVGs FAST with Python</p><small>October 06, 2018</small></a><a class="aside__nav-link" href="/blog/9-27-18"><p>Hide your keys, folks (Part I)</p><small>September 27, 2018</small></a><a class="aside__nav-link" href="/blog/8-24-18"><p>NeXT Logo in HTML and CSS</p><small>August 24, 2018</small></a><a class="aside__nav-link" href="/blog/8-18-18"><p>Revisiting Python Data Analysis: Part 2</p><small>August 18, 2018</small></a><a class="aside__nav-link" href="/blog/8-13-18"><p>MIT 6.00.1x Course Review</p><small>August 13, 2018</small></a><a class="aside__nav-link" href="/blog/8-11-18"><p>Revisiting Python Data Visualizationd</p><small>August 11, 2018</small></a><a class="aside__nav-link" href="/blog/8-09-18"><p>Styled Components</p><small>August 09, 2018</small></a><a class="aside__nav-link" href="/blog/8-06-18"><p>Learning to program</p><small>August 06, 2018</small></a><a class="aside__nav-link" href="/blog/8-05-18"><p>Hello World!</p><small>August 05, 2018</small></a></nav></aside><article class="blog"><header class="blog__header"><div class="container"><h1>How NOT to Create a Dropbox Clone</h1><h3>November 21, 2018</h3></div></header><div class="blog__post"><div class="blog__post-content"><p><img src="https://i.imgur.com/LE7G4bH.jpg" alt="flask file app"></p>
<p>I recently built a file-hosting application using Flask. Nothing fancy — users can upload, download, and delete files. The catch, however, is that the files are saved directly on the server, and that's not good. </p>
<p>It's not good because I need that server space, and common file types (e.g., images, powerpoints, etc.) can be <strong>massive</strong>. Consequently, it won't be very long until I run out of memory and things go horribly wrong.</p>
<p>The solution is to host your files on an <a href="https://aws.amazon.com/s3/">Amazon S3</a>, which is quite easy thanks to the library <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a>. I will dedicate another post to discuss how I converted this app from hosting the files from the server to S3 (namely because I am still building the S3 version), but first let's look at the <strong>wrong</strong> way to create a file-hosting app.</p>
<h2>Introduction</h2>
<hr>
<p>This application is a highly modified version of <a href="http://flask.pocoo.org/docs/1.0/patterns/fileuploads/">Flask's documentation on file-uploading</a>. Before I present the code, here are a few key-points:</p>
<ul>
<li>
<p><strong>It's important to designate what files users can upload.</strong> This ensures no one will upload a file that runs on our server and causes damage, such as those with a <em>.bash</em> file-extension.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">ALLOWED_EXTENSIONS <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'txt'</span><span class="token punctuation">,</span> <span class="token string">'pdf'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'jpeg'</span><span class="token punctuation">,</span> <span class="token string">'gif'</span><span class="token punctuation">,</span> <span class="token string">'docx'</span><span class="token punctuation">,</span> <span class="token string">'xlsx'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<br/>
</li>
<li>
<p><strong>You need to secure your file names.</strong> We import <em>secure_filename</em> from <em>werkzeug</em> to, well, secure our filenames before saving it. Here is a description of <em>secure_filename</em> from the docs:</p>
<blockquote>
<p>Pass it a filename and it will return a secure version of it. This filename can then safely be stored on a regular file system and passed to os.path.join(). The filename returned is an ASCII only string for maximum portability.</p>
</blockquote>
</li>
</ul>
<br/>
<ul>
<li>
<p><strong>os library does the heavy lifting.</strong> We need to use the <em>os</em> library to create/delete folders for each user and save/delete files to/from the local machine. </p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># Grab the user folder</span>
user_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                            <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Save the uploaded file(s) to the user's dir</span>
<span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>user_file_path<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<br/>
</li>
</ul>
<p>Now that we covered some of the key points, let us take a look at some code.</p>
<!-- Once users authenticate their account, they may upload files with the following extensions:


| Office | Images | Other |
|:------:|:-----:|:-----:|
| docx | jpg  | pdf  |
| xlsx | png  | txt  |
| ppt  | gif  |      |

These file extensions reflect what I would typically keep on Google drive, Dropbox, or a USB drive. 

```python
ALLOWED_EXTENSIONS = set(['txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'docx', 'xlsx'])

``` -->
<br />
<h2>The Heart of the App</h2>
<hr>
<p>Here is the primary logic of the application. It has not been refactored or cleaned up at all since I've been converting this to <em>S3</em>. If I were to modify this, I would move the file validation and saving logic to separate functions, but for the purposes of this tutorial having all the logic in one place is more convenient.</p>
<p>If the code below doesn't make much sense, don't worry. In the next section I will be break down precisely what's happening here.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> request<span class="token punctuation">,</span> \
    url_for<span class="token punctuation">,</span> send_from_directory
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> login_user<span class="token punctuation">,</span> logout_user<span class="token punctuation">,</span> current_user<span class="token punctuation">,</span> login_required
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>utils <span class="token keyword">import</span> secure_filename
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url_parse
<span class="token keyword">from</span> app <span class="token keyword">import</span> app<span class="token punctuation">,</span> db
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">,</span> File
<span class="token keyword">from</span> app<span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm<span class="token punctuation">,</span> RegistrationForm<span class="token punctuation">,</span> DeleteUserForm

ALLOWED_EXTENSIONS <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'txt'</span><span class="token punctuation">,</span> <span class="token string">'pdf'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'jpeg'</span><span class="token punctuation">,</span> <span class="token string">'gif'</span><span class="token punctuation">,</span> <span class="token string">'docx'</span><span class="token punctuation">,</span> <span class="token string">'xlsx'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">allowed_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'.'</span> <span class="token keyword">in</span> filename <span class="token operator">and</span> \
           filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> ALLOWED_EXTENSIONS

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
@login_required
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    files <span class="token operator">=</span> current_user<span class="token punctuation">.</span>files
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token comment"># check if the post request has the file part</span>
        <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token operator">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'No file part'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
        <span class="token comment"># if user does not select file, browser also</span>
        <span class="token comment"># submit an empty part without filename</span>
        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'No selected file'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">file</span> <span class="token operator">and</span> allowed_file<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
            filename <span class="token operator">=</span> secure_filename<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
            <span class="token comment"># see if user has file of same name</span>
            <span class="token comment"># if so, prompt them to rename the file</span>
            <span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">:</span>                
                <span class="token keyword">if</span> f<span class="token punctuation">.</span>name <span class="token operator">==</span> filename<span class="token punctuation">:</span>
                    flash<span class="token punctuation">(</span><span class="token string">'You already have a file with that name! Please rename your file and upload.'</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># make user's dir using ID</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                    app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            user_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>user_file_path<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
            user_file <span class="token operator">=</span> File<span class="token punctuation">(</span>path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>user_file_path<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
                             rel_path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                                 <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
                             name<span class="token operator">=</span>filename<span class="token punctuation">,</span>
                             user_id<span class="token operator">=</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user_file<span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            flash<span class="token punctuation">(</span><span class="token string">'File uploaded!'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> user<span class="token operator">=</span>current_user<span class="token punctuation">)</span></code></pre></div>
<br />
<h2>Uploading Files</h2>
<hr>
<p>I won't delve into the authentication aspect of this application because it's fairly trivial. In terms of the file-uploading, users must be logged in to upload and download files. Additionally, users are unable to modify or access the files of other users.</p>
<p>Now let's take a look at the file-uploading logic. </p>
<h3>Check the File(s)</h3>
<p>Before a user upload's a file, we need to check a number of things.</p>
<ol>
<li>
<p>Is the <em>POST</em> request sending files?</p>
<p>We only want to be implementing logic if user is uploading files, otherwise
someone is using the route improperly and will be redirected.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token operator">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
    flash<span class="token punctuation">(</span><span class="token string">'No file part'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span></code></pre></div>
<br/>
</li>
<li>
<p>Check to see if there is a file in the request.</p>
<p>So we already know that the response object contains the files key,
but does it contain any files? That's what is being asked here.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
<span class="token comment"># if user does not select file, browser also</span>
<span class="token comment"># submit an empty part without filename</span>
<span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
    flash<span class="token punctuation">(</span><span class="token string">'No selected file'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span></code></pre></div>
<br/>
</li>
<li>
<p>Make sure we support the file extension and pass it to <em>secure_filename</em> (described above)</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">if</span> <span class="token builtin">file</span> <span class="token operator">and</span> allowed_file<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    filename <span class="token operator">=</span> secure_filename<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span></code></pre></div>
<br/>
</li>
<li>
<p>Ensure user doesn't already have a file with the same name.</p>
<p> Currently, each user has one folder to upload files to.
Thus, to prevent naming collisions, each file name must be unique.
Note the filename includes the extension, so a user can
have <em>user.docx</em> file and <em>user.ppt</em> file but not two <em>user.docx</em> files.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">:</span>                
    <span class="token keyword">if</span> f<span class="token punctuation">.</span>name <span class="token operator">==</span> filename<span class="token punctuation">:</span>
        flash<span class="token punctuation">(</span><span class="token string">'You already have a file with that name! Please rename your file and upload.'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<br/>
</li>
</ol>
<h3>User Folders</h3>
<p>All files are uploaded to an <em>UPLOAD_FOLDER</em> whose location is configured in <em>config.py</em> — all user folders are a child of this folder.</p>
<p>Each user has a designated directory to upload files to, which is named using the user's id.
Whenever a user upload's a file, we check to see if this user has a folder via <em>os.path.exists()</em>. If the user doesn't have a folder, we create one using <em>os.mkdir()</em></p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<br/>
<p>Once we have a folder for our user, we grab its absolute path and save it to a variable.
This makes the code a bit cleaner for when we save the file. Note that <em>file</em> is referencing  <em>file = request.files['file']</em> from the <em>POST</em> request described above.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">user_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Save file </span>
<span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>user_file_path<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<br/>
<p>And that's about it in terms of the file-uploading logic. Now let's look at the database for this application.</p>
<h2>Database</h2>
<hr>
<p>First, let's cover some general information. This application's database uses <em>Postgresql</em> for deployment, <em>Sqlite3</em> for development, and was written using the <em>SQLAlchemy</em> ORM. </p>
<p>The database is built on a one-to-many between the <em>&#x3C;User></em> and <em>&#x3C;File></em> models, i.e., each <em>User</em> has a relationship to many objects in the <em>File</em> table. </p>
<h3>Schemas</h3>
<p>Take note of the <em>file</em> attribute on the <em>&#x3C;User></em> model and the <em>user_id</em> attribute on the <em>&#x3C;File></em>, for this is how we connect the two tables.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>UserMixin<span class="token punctuation">,</span> db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password_hash <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    files <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'File'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'author'</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">'dynamic'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">set_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>password_hash <span class="token operator">=</span> generate_password_hash<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">check_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> check_password_hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>password_hash<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;User {}>'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>email<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    
    user_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'user.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    path <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rel_path <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;File {}>'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span></code></pre></div>
<br />
<p>Here I will use a modified version of the <a href="https://docs.sqlalchemy.org/en/latest/orm/backref.html">SQLAlchemy docs</a> to describe what is happening in the <em>file</em> attribute:</p>
<blockquote>
<p>The above configuration establishes a collection of File objects on User called User.files. It also establishes a .user attribute on Address which will refer to the parent User object.</p>
</blockquote>
<p>I am also using <em>lazy='dynamic'</em>, which is a bit of a controversial issue. Essentially the argument is meant to deal with large databases and loading of collections, though I've uncovered some <a href="https://github.com/mitsuhiko/flask-sqlalchemy/issues/435">discussions on github</a> that indicate it may be not improve performance. Either way, it is a bit beyond the scope of this post.</p>
<h2>Conclusion</h2>
<hr>
<p>That's pretty much it. Despite the fact this project is very practically for the reasons mentioned earlier, it provided my first exposure to file uploading and I learned a fair-amount.</p>
<p>However, the best thing to come from this application is that is led me to <em>S3</em>, which will enable me to do some really awesome things. </p></div></div></article></main></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-template-js","jsonName":"blog-11-21-18-f4e","path":"/blog/11-21-18"};window.dataPath="658/path---blog-11-21-18-f-4-e-c1d-bfhqyGa5u8i8TzrL93yoIKVnp8";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.a2f933b7ab5f58f2ecfb.css","/app-33a09fa39d4bb1a5da5e.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js.592af373a9de1595b330.css","/component---src-templates-blog-template-js-63c5b76c2806537627a9.js"],"component---src-pages-404-js":["/component---src-pages-404-js.592af373a9de1595b330.css","/component---src-pages-404-js-9f913e74baff38c884d0.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js.592af373a9de1595b330.css","/component---src-pages-blog-js-431135db50a87f62a90d.js"],"component---src-pages-index-js":["/component---src-pages-index-js.592af373a9de1595b330.css","/component---src-pages-index-js-b1825cc2981131d85613.js"],"component---src-pages-success-js":["/component---src-pages-success-js.592af373a9de1595b330.css","/component---src-pages-success-js-7c26c2bc469a7b69b07c.js"],"pages-manifest":["/pages-manifest-2fec3dfce8c9fe9e487b.js"]};/*]]>*/</script><script src="/webpack-runtime-e208b5e9dd72a0235a91.js" async=""></script><script src="/app-33a09fa39d4bb1a5da5e.js" async=""></script><script src="/component---src-templates-blog-template-js-63c5b76c2806537627a9.js" async=""></script></body></html>