{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/1-6-2019","webpackCompilationHash":"5cac571cb7eb216fe4c3","result":{"data":{"markdownRemark":{"html":"<p><img src=\"https://images.unsplash.com/photo-1512668033346-09cfb0d8597b?ixlib=rb-1.2.1&#x26;ixid=eyJhcHBfaWQiOjEyMDd9&#x26;auto=format&#x26;fit=crop&#x26;w=700&#x26;q=60\" alt=\"cookies\"></p>\n<p>Alright, so you feel pretty strong in your frontend development skills, learned a framework like React, and now want build some back-end applications. You create some APIs, learn about databases, authentication, all is well.</p>\n<p>Then you may begin to wonder — how do I connect my front-end SPA with my back-end application? Or more specifically, how does one implement authentication when you can't pass data directly into something like a template?</p>\n<p>This is the question I will answer in this post, though the answer really comes down to one thing — <strong>cookies</strong>.</p>\n<h3>Basic Idea</h3>\n<p>Let's say someone submits valid login credentials from the browser (i.e., signs in). We will use a library — which will be discussed more thoroughly in a moment— that will create a \"session\" with this user, enabling the user to access things that require being logged in. So what is a \"session?\" </p>\n<p>Well, it's basically the server and client passing back and forth a special kind of <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies\">http cookie</a> known as a   <code class=\"language-text\">session-cookie</code>. The backend application checks for this cookie when the client attempts to access protected routes. Furthermore, it is the job of the client to include this cookie when making HTTP requests to restricted content from the app, such as access to a user's inbox. No cookie, no protected content. You can also set expirations on your cookies — expired cookies also won't get access privileges.</p>\n<p>Again, it's a back and forth. </p>\n<ol>\n<li>The client logs in and gets a session-cookie from the server </li>\n<li>The client makes a request to restricted content on the server, including the cookie it just received</li>\n<li>The server gets the cookie via the HTTP request; if the cookie is valid, the app responds with the restricted content and a new cookie for the client to include on the next request, otherwise redirect with a  <code class=\"language-text\">403</code> error. </li>\n<li>This process repeats for subsequent requests until the user logs out, in which case the app does not respond with a cookie. Since the app didn't respond with a cookie (or at least not one that will provide authentication), the client has nothing to offer the backend for protected content until it logs in again.</li>\n</ol>\n<p>This is why HTTPS is so important. If communication between the browser and server is not encrypted, someone could potentially intercept your cookie and use it to access your account information, which is bad.</p>\n<p>Since we are talking about security, cookies have a feature that helps protect users from <a href=\"https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)\">XSS-attacks</a> — <code class=\"language-text\">httpOnly</code>.</p>\n<p>An excerpt from <a href=\"\">OWASP's article on HttpOnly</a>:</p>\n<blockquote>\n<p>According to Michael Howard, Senior Security Program Manager in the Secure Windows Initiative group at Microsoft, the majority of XSS attacks target theft of session cookies. A server could help mitigate this issue by setting the HttpOnly flag on a cookie it creates, indicating the cookie should not be accessible on the client.</p>\n</blockquote>\n<p>Essentially, without this feature, a hacker could potentially run a script in a user's browser and access a session-cookie via the <code class=\"language-text\">document.cookie</code> API.</p>\n<p>Okay, now that that's out of the way, let's get to some code!</p>\n<h2>Preqrequisites</h2>\n<hr>\n<ul>\n<li>Flask knowledge (or some backend and/or Python experience)</li>\n<li>Knowledge of a JS framework (I'll be using React)</li>\n</ul>\n<h2>Flask</h2>\n<hr>\n<p>I like Flask a lot, primarily because I like Python a lot. It also has a pretty solid community and good documentation for the major libraries. Regardless, the general ideas discussed here can be applied by developers of any stack.</p>\n<p>Now session management is something you can attempt to do on your own, but unless you know what you're doing, it's probably best to use a library. I use the <a href=\"https://flask-login.readthedocs.io/en/latest/\">flask-login</a> library, which is pretty much the go to for session management in the Flask community. From the <code class=\"language-text\">flask-login</code> docs:</p>\n<blockquote>\n<p>Flask-Login provides user session management for Flask. It handles the common tasks of logging in, logging out, and remembering your users’ sessions over extended periods of time.</p>\n</blockquote>\n<p>Let's look at some of the tools that <code class=\"language-text\">flask-login</code> provides. We will break down these imports one by one.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> flask_login <span class=\"token keyword\">import</span> login_required<span class=\"token punctuation\">,</span> login_user<span class=\"token punctuation\">,</span>\\\n                        current_user<span class=\"token punctuation\">,</span> logout_user</code></pre></div>\n<br />\n<p>Before we get into these methods, however, it's important to note none of this will work unless you have configured a secret-key for your app:</p>\n<blockquote>\n<p>  By default, Flask-Login uses sessions for authentication. This means you must set the secret key on your application, otherwise Flask will give you an error message telling you to do so.</p>\n</blockquote>\n<p>If you are not exactly sure what all this means, I suggest you take a look at the <a href=\"http://flask.pocoo.org/docs/1.0/quickstart/#sessions\">Flask docs on Sessions</a>.</p>\n<h3>login__user</h3>\n<p>Let's see what this looks like in action:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/login'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">:</span>\n        user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>filter_by<span class=\"token punctuation\">(</span>username<span class=\"token operator\">=</span>request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'username'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> user <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">or</span> <span class=\"token keyword\">not</span> user<span class=\"token punctuation\">.</span>check_password<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Invalid username and/or password\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">401</span>  \n        login_user<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>        \n        <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">:</span> current_user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>            \n             <span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Logged in!\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>So what is <em>login_user</em> doing anyway? Well, it is creating an active session with the client who made the request.</p>\n<p>When you log in a user using <em>login_user</em>, you are essentially saying, \"Based on the credentials submitted, I trust this person and will give this person a signed-cookie to use on future requests.\" It is still the job of the client to include this cookie on subsequent requests, but we will cover that in a bit.</p>\n<p>Configuring <em>login_user</em> takes a bit of work though and will not be covered here, but <a href=\"https://flask-login.readthedocs.io/en/latest/\">here are the docs</a>. </p>\n<h3>logout_user</h3>\n<p>Logging out the user is really easy:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/logout'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    logout_user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Logged out!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>It does the opposite of <em>login_user</em> in that it closes the session and doesn't give the user a cookie. Since we didn't return a cookie, the client now has nothing to give the server for auth routes. </p>\n<h3>login_required</h3>\n<p>This is middleware that will check for that all-important session. If the user presents a valid session, they make it through the middleware, otherwise the user is redirected with 403 .</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/post/&lt;post_id>/delete'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n@login_required\n<span class=\"token keyword\">def</span> <span class=\"token function\">delete_post</span><span class=\"token punctuation\">(</span>post_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>    \n    <span class=\"token keyword\">if</span> post_id <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"You did not send me anything\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    post <span class=\"token operator\">=</span> Post<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>filter_by<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>post_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> post_id <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"Post not found. Are you trying to break me?\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">204</span>\n    db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>delete<span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span>\n    db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Post removed!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<h3>current_user</h3>\n<p>When a user logs in, it's because that person is trying to access data associated with that user. Consequently, the back-end needs to know who the user is for db queries, etc. This is what <em>current_user</em> is — the user returned from the &#x3C;User> table when we log a user in.     </p>\n<p>Consider the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">post <span class=\"token operator\">=</span> Post<span class=\"token punctuation\">(</span>body<span class=\"token operator\">=</span>request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> author<span class=\"token operator\">=</span>current_user<span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>Really all that is being done here is that <em>current_user</em> is referencing the user contained in the session created with <em>login_user</em>. Python is really nice, isn't it?</p>\n<h2>Front-end</h2>\n<hr>\n<p>The front end work comes down to one thing really, and that is including credentials when using the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API\">Fetch API</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">getPosts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://api.something.com/post'</span> <span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>      \n      credentials<span class=\"token punctuation\">:</span> <span class=\"token string\">'include'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>            \n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">!==</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>      \n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>posts<span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">.</span>posts<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>            \n      <span class=\"token keyword\">return</span> \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>      \n      <span class=\"token function\">navigate</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/err/</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Remember how I said the only thing the client needs to do is include the cookie sent by the server — that is what we're doing we set <em>credentials: 'include'</em>. Otherwise, the client won't include the cookie since the Fetch API does not include credential by default, which is a good thing.</p>\n<!-- ### Form Submission\nOnce a user submits a form, you're all set. Provided the logic of the form submission is sound, the back-end will provide the necessary cookies for authenticated users. I told you it was simple. -->\n<h2>Conclusion</h2>\n<hr>\n<p>Really this whole post can be boiled down to a few basic principles, but sometimes it's nice to have things explained. Anyway, let's review said basic principles:</p>\n<ul>\n<li>If a client submits valid username and password that client will get a cookie until the user decides to log out or the cookie expires. This cookie will be used to authenticate future requests.</li>\n<li>Once a user submits a valid login, all the client must do it is include the cookie provided by the server on subsequent requests.</li>\n</ul>\n<p>From there, things like rerouting can be handled programmatically by the SPA. Regardless of what a potential hacker does to manipulate the front-end and access privileged pages, the perpetrator will not be able to access data without providing legitimate credentials, and that is really awesome.</p>","frontmatter":{"date":"January 06, 2019","path":"/blog/1-6-2019","title":"Connect your SPA with your Back-end","info":"A lesson in cookie-authentication using Gatsby and Flask"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}